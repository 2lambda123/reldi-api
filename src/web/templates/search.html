{% extends "layout.html" %}
{% block body %}
<div class="panel panel-default">

    {% with title = 'Query' %}
        {% include 'parts/heading.html' %}
    {% endwith %}
    <div id="search-panel" class="panel-body">

    </div>
</div>
{% endblock %}


{% block react %}
<script type="text/babel">
    ReactDOM.render(
        <SearchForm />,
        document.getElementById('search-panel')
    );
</script>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    function generateGuid() {
         var S4 = function() {
            return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        };
        return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
    }

    function showSearch(e) {
        $('#lexicon-results-wrapper').hide();
        $('#lexicon-result-area').hide();
        $('#results').show();
        $('#result-area').show();
        $('#download-result').show();
        $("#error-message").text('');
    }

    function showLexicon() {
        $('#lexicon-results-wrapper').show();
        $('#lexicon-result-area').show();
        $('#results').hide();
        $('#result-area').hide();
        $('#download-result').hide();
        $("#error-message").text('');
    }
    $("#lexicon_link").click(showLexicon);
    $("#search_link").click(showSearch);
    showSearch();
    $('#download-result').attr('disabled', 'disabled');


    function xmlToString(xmlData) {
        xmlData = $(xmlData);
        if (window.ActiveXObject) {
            return xmlData.xml;
        } else {
            var oSerializer = new XMLSerializer();
            return oSerializer.serializeToString(xmlData[0]);
        }
    }


    $('#tagger-file-chooser').change(function(e) {
        if ($(this).val() != '') {
            $('#input-text').attr('disabled', 'disabled');
        } else {
            $('#input-text').removeAttr('disabled');
        }
    });

    $('#remove-file').click(function(e) {
        $('#tagger-file-chooser').val('');
        $('#input-text').removeAttr('disabled');
    });

    /* clear functions */
    $("#tagger-clear-button").click(function() {
        $("#input-text").val('');
        $("#input-format-1").prop("checked", false);
        $("#input-format-2").prop("checked", false);

        $("#method1").prop("checked", false);
        $("#method2").prop("checked", false);
        $("#method3").prop("checked", false);

        $("#results").empty();
        $(".display-result-search").empty();
        $('#download-result').attr('disabled', 'disabled');
        $("#error-message").text('');

    });
    $("#lexicon-clear-button").click(function() {
        $("#inputSurface").val("");
        $("#inputLemma").val("");
        $("#inputMsd").val("");
        $("#inputRhymesWith").val("");
        $("#inputNoOfSyllables").val("");
        $("#surface_is_regex").prop("checked", false);
        $("#lemma_is_regex").prop("checked", false);
        $("#msd_is_regex").prop("checked", false);
        $("#lexicon-result-area").empty();
        $("#lexicon-results-wrapper").empty();
        $("#lexicon-results-wrapper").append("<table id='lexicon-results' class='table' cellspacing='0' width='100%'><thead><th>Lemma</th><th>Tag</th><th>Surface</th></thead></table>");
        $("#error-message").text('');

    });

    var baseUrl = '/api/v1/';
    $('#search-form').submit(function(e) {
        e.preventDefault();
    });
    $('#lexicon-form').submit(function(e) {
        e.preventDefault();
    });
    $("#search-button").click(function(e) {
        e.preventDefault();
        $("#error-message").text('');

        var text = $("#input-text").val();
        var file = $('#tagger-file-chooser').val();
        var inputFormat = $('input[name="input-format"]:checked').val();
        var method = $('input[name="method"]:checked').val();

        if ((!file && !text) || !inputFormat || !method) {
            console.log(file, text);
            return;
        }

        $(".display-result-search").empty();
        var lang = $('#search-form .language').val();
        var url = baseUrl + lang + '/' + method;
        var data = new FormData();
        data.append('format', inputFormat);

        var requestId = generateGuid();
        data.append('request-id', requestId);
        if (file) {
            data.append('file', $('#tagger-file-chooser')[0].files[0]);
        } else {
            data.append('text', text)
        }

        $("#search-button").text('Processing ...').attr('disabled', 'disabled');
        var sendDate = (new Date()).getTime();
        var trHTML = '';
        $('#results').empty();

        jQuery.ajax({
            type: "POST",
            dataType: inputFormat == 'json' ? 'json' : 'xml',
            url: url,
            data: data,
            processData: false,
            contentType: false,
            success: function(data, status, xml) {

                var downloadLink = "{{ url_for('web_router.download', requestId='') }}" + requestId;
                $('#download-result').removeAttr('disabled').attr('href', downloadLink);
                if (inputFormat == 'json') {

                    $("#result-area").text(JSON.stringify(data, null, 4));
                    if (method == "tag") {
                        $("#results").append("<thead><tr><th>Token</th><th>Tag</th><th>Start - End index</th></tr></thead>");
                        $.each(data.tokens, function(i, item) {
                            trHTML += '<tbody><tr><td>' + item.value + '</td><td id=' + i + '_tag></td><td>' + item.startChar + ' - ' + item.endChar + '</td></tr></tbody>';
                        });
                        var k=0;
                        $('#results').append(trHTML);
                        $.each(data.POSTags, function(i, tag) {
                            $("#" + k + "_tag").html(tag.value);
                            k=k+1;
                        });

                    } else if (method == "lemmatise") {
                        $("#results").append("<thead><tr><th>Token</th><th>Lemma</th><th>Start - End index</th></tr></thead>");
                        $.each(data.tokens, function(i, item) {
                            trHTML += '<tbody><tr><td>' + item.value + '</td><td id=' + i + '_lemma></td><td>' + item.startChar + ' - ' + item.endChar + '</td></tr></tbody>';
                        });
                        $('#results').append(trHTML);
                        var k=0
                        $.each(data.lemmas, function(i, lemma) {
                            $("#" + k + "_lemma").html(lemma.value);
                            k=k+1;
                        });
                    } else if (method == "tag_lemmatise") {
                        $("#results").append("<thead><tr><th>Token</th><th>Tag</th><th>Lemma</th><th>Start - End index</th></tr></thead>");
                        $.each(data.tokens, function(i, item) {
                            trHTML += '<tbody><tr><td>' + item.value + '</td><td id=' + i + '_tag></td><td id=' + i + '_lemma></td><td>' + item.startChar + ' - ' + item.endChar + '</td></tr></tbody>';
                        });
                        $('#results').append(trHTML);
                        var k=0;
                        $.each(data.POSTags, function(i, tag) {
                            $("#" + k + "_tag").html(tag.value);
                            k=k+1;
                        });
                        var m=0;
                        $.each(data.lemmas, function(i, lemma) {
                            $("#" + m + "_lemma").html(lemma.value);
                            m=m+1;
                        });
                    }
                } else {
                    $("#result-area").text(xml.responseText);
                    if (method == "tag") {
                        $("#results").append("<thead><tr><th>Token</th><th>Tag</th><th>Start - End character index</th></tr></thead>");
                        $(xml.responseText).find("token").each(function(index) {
                            trHTML += '<tbody><tr><td>' + $(this).text() + '</td><td id=' + index + '_tag></td><td>' + $(this).attr("startChar") + '-' + $(this).attr("endChar") + '</td></tr></tbody>';
                        });
                        $('#results').append(trHTML);
                        $(xml.responseText).find("tag").each(function(index) {
                            $("#" + index + "_tag").html($(this).text());
                        });
                    } else if (method == "lemmatise") {
                        $("#results").append("<thead><tr><th>Token</th><th>Lemmatise</th><th>Start - End character index</th></tr></thead>");
                        $(xml.responseText).find("token").each(function(index) {
                            trHTML += '<tbody><tr><td>' + $(this).text() + '</td><td id=' + index + '_lemma></td><td>' + $(this).attr("startChar") + '-' + $(this).attr("endChar") + '</td></tr></tbody>';
                        });
                        $('#results').append(trHTML);
                        $(xml.responseText).find("lemma").each(function(index) {
                            $("#" + index + "_lemma").html($(this).text());
                        });
                    } else if (method == "tag_lemmatise") {
                        $("#results").append("<thead><tr><th>Token</th><th>Tag</th><th>Lemmatise</th><th>Start - End character index</th></tr></thead>");
                        $(xml.responseText).find("token").each(function(index) {
                            trHTML += '<tbody><tr><td>' + $(this).text() + '</td><td id=' + index + '_tag></td><td id=' + index + '_lemma></td><td>' + $(this).attr("startChar") + '-' + $(this).attr("endChar") + '</td></tr></tbody>';
                        });
                        $('#results').append(trHTML);
                        $(xml.responseText).find("lemma").each(function(index) {
                            $("#" + index + "_lemma").html($(this).text());
                        });
                        $(xml.responseText).find("tag").each(function(index) {
                            $("#" + index + "_tag").html($(this).text());
                        });
                    }
                }

            },
            error: function(response) {
                $('#download-result').attr('disabled', 'disabled');
                $("#error-message").text(JSON.parse(response.responseText));
            },
            complete: function(data) {
                var receiveDate = (new Date()).getTime();
                var responseTimeMs = receiveDate - sendDate;
                var responseTimeText = ' (response time: ' + (responseTimeMs / 1000.0) + 's)';
                $('#response-time').text(responseTimeText);
                $("#search-button").text('Process').removeAttr('disabled');
            }
        });


    });
    $("#lexicon-button").click(function(e) {
        e.preventDefault();
        $("#error-message").text('');

        var surface = $("#inputSurface").val();
        var lemma = $("#inputLemma").val();
        var msd = $("#inputMsd").val();
        var rhymes_with = $("#inputRhymesWith").val();
        var no_of_syllables = $("#inputNoOfSyllables").val();

        var surface_is_regex = $("#surface_is_regex").is(":checked") ? 1 : 0;
        var lemma_is_regex = $("#lemma_is_regex").is(":checked") ? 1 : 0;
        var msd_is_regex = $("#msd_is_regex").is(":checked") ? 1 : 0;

        $(".display-result-search").empty();
        var lang = $('#lexicon-form .language').val();
        var method = 'lexicon';
        var inputFormat = 'json';
        var url = baseUrl + lang + '/' + method;
        var data = {
            surface: surface !== '' ? surface : null,
            lemma: lemma !== '' ? lemma : null,
            msd: msd !== '' ? msd : null,
            rhymes_with: rhymes_with !== '' ? rhymes_with : null,
            no_of_syllables: no_of_syllables !== '' ? no_of_syllables : null,
            surface_is_regex: surface_is_regex,
            lemma_is_regex: lemma_is_regex,
            msd_is_regex: msd_is_regex
        };

        $("#lexicon-button").text('Processing ...').attr('disabled', 'disabled');
        var sendDate = (new Date()).getTime();

        jQuery.ajax({
            type: "GET",
            dataType: 'json',
            url: url,
            data: data
        }).success(function(data) {
            dataset = data.result;
            var table = $('#lexicon-results').dataTable();
            if (table == 'undefined') {
                var table = $('#lexicon-results').DataTable({
                    data: dataset,
                    columns: [{ title: "Surface from" }, { title: "Tags" }, { title: "Lemma" }]
                });
            } else {
                table.fnClearTable();
                if (dataset.length > 0) {
                    table.fnAddData(dataset);
                }
            }
            $("#lexicon-result-area").text(JSON.stringify(dataset));
        }).fail(function(response) {
            $("#result-area").text(JSON.parse(response.responseText));
        }).always(function(data) {
            var receiveDate = (new Date()).getTime();
            var responseTimeMs = receiveDate - sendDate;
            var responseTimeText = ' (response time: ' + (responseTimeMs / 1000.0) + 's)';
            $('#response-time').text(responseTimeText);
            $("#lexicon-button").text('Process').removeAttr('disabled');
        });
    });

</script>
{% endblock %}
